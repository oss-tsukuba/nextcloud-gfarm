#! /bin/bash

set -eu -o pipefail

remount_opt="$1"
gfarm_path="$2"
mountpoint="$3"

lockfile="${mountpoint}.lock"

facility="local7"

: ${GFARM_ATTR_CACHE_TIMEOUT:="60"}
: ${FUSE_ENTRY_TIMEOUT:="60"}
: ${FUSE_NEGATIVE_TIMEOUT:="5"}
: ${FUSE_ATTR_TIMEOUT:="60"}
: ${GFARM2FS_LOGLEVEL:="info"}

MNT_OPT="-o loglevel=${GFARM2FS_LOGLEVEL},nonempty,modules=subdir,entry_timeout=${FUSE_ENTRY_TIMEOUT},negative_timeout=${FUSE_NEGATIVE_TIMEOUT},attr_timeout=${FUSE_ATTR_TIMEOUT},gfs_stat_timeout=${GFARM_ATTR_CACHE_TIMEOUT},auto_cache,big_writes"

if [ "$remount_opt" = "REMOUNT=1" ]; then
    remount=1
else
    remount=0
fi

LOG_DEBUG()
{
    logger -p ${facility}.debug "$0" "DEBUG: $@"
}

LOG_ERR()
{
    logger -p ${facility}.err "$0" "ERR: $@"
}

lock_expired()
{
    min=1
    num=$(find "$lockfile" -maxdepth 0 -type d -mmin +${min} > /dev/null 2>&1 | wc -l)
    if [ -e "$lockfile" -a  $num -eq 1 ]; then
        return 0  # expired
    fi
    return 1
}

lock_and_wait()
{
    while ! mkdir "$lockfile" > /dev/null 2>&1; do
        if lock_expired; then
            break
        fi
        LOG_DEBUG "wait for other mount"
        sleep 1
    done
    return 0
}

unlock()
{
    rmdir "$lockfile" || :
}

check_mounted()
{
    if [ ! -d "$mountpoint" ]; then
        mkdir -p "$mountpoint"
        return 0
    fi

    dfout=$(df "$mountpoint" | tail -1)
    dffstype=$(echo "$dfout" | awk '{print $1}')
    dfmp=$(echo "$dfout" | awk '{print $6}')

    if [ $dffstype = "gfarm2fs" ]; then
        if [ "$mountpoint" = "$dfmp" ]; then
            LOG_DEBUG "already mounted: $mountpoint"
            exit 0
        else
            #LOG_ERR "unexpected: mountpoint=${mountpoint} != $dfmp"
            #exit 1
            remount=1
        fi
    fi
    # not mounted
}


check_mounted

trap unlock EXIT

lock_and_wait

LOG_DEBUG "$@"

if [ $remount -eq 1 ]; then
    fusermount -u "${mountpoint}"
fi
gfarm2fs ${MNT_OPT} -o subdir="${gfarm_path}" "${mountpoint}"
retval=$?
if [ $retval -ne 0 ]; then
    LOG_ERR "gfarm2fs mount failed: mountpoint=${mountpoint}"
fi
exit $retval
